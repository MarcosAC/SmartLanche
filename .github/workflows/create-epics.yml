name: Create Epics and Add to Kanban
on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-epics:
    runs-on: ubuntu-latest

    steps:
      - name: Create Epics Column if Needed
        id: create-column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectId = 7;
            const columnName = "Epics";

            // Buscar colunas existentes
            const { data: columns } = await github.rest.projects.listColumns({
              project_id: projectId
            });

            let epicsColumn = columns.find(c => c.name === columnName);

            // Criar a coluna se n√£o existir
            if (!epicsColumn) {
              const { data: newColumn } = await github.rest.projects.createColumn({
                project_id: projectId,
                name: columnName,
              });
              epicsColumn = newColumn;
            }

            core.setOutput("column_id", epicsColumn.id);

      - name: Create Epics Issues
        id: create-issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            function ml(text) {
              return text.join("\n");
            }

            const epics = [
              {
                title: "EPICO 1 - Sistema de Pedidos",
                body: ml([
                  "### Feature 1.1 - Criar Pedido",
                  "",
                  "#### Historias",
                  "- US-001 - Criar pedido manualmente",
                  "- US-002 - Adicionar itens ao pedido",
                  "- US-003 - Excluir ou alterar itens",
                  "",
                  "#### Tarefas",
                  "- Criar tela de novo pedido",
                  "- Criar model Pedido",
                  "- Criar model ItemPedido",
                  "- Persistencia local (EF Core / SQL Server LocalDB)",
                  "- Calcular total automaticamente",
                  "- Validacoes",
                  "",
                  "---",
                  "",
                  "### Feature 1.2 - Acompanhar Pedido",
                  "",
                  "#### Historias",
                  "- US-004 - Visualizar pedidos em aberto",
                  "- US-005 - Atualizar status (A Fazer, Em Preparo, Pronto)",
                  "",
                  "#### Tarefas",
                  "- Tela: Lista de pedidos",
                  "- Integracao com fluxo da cozinha",
                  "- Atualizar status",
                  "- Notificacoes visuais"
                ])
              },

              {
                title: "EPICO 2 - Sistema da Cozinha",
                body: ml([
                  "### Feature 2.1 - Visualizacao dos Pedidos",
                  "- US-006 - Tela da cozinha atualizando em tempo real",
                  "- US-007 - Ordenar por ordem de chegada",
                  "",
                  "### Feature 2.2 - Conclusao de Pedido",
                  "- US-008 - Marcar pedido como pronto",
                  "",
                  "#### Tarefas",
                  "- Conectar com o banco",
                  "- Atualizacao automatica",
                  "- Filtrar pedidos prontos"
                ])
              },

              {
                title: "EPICO 3 - Catalogo de Produtos",
                body: ml([
                  "### Feature 3.1 - CRUD de Produtos",
                  "",
                  "#### Historias",
                  "- US-009 - Cadastrar produtos",
                  "- US-010 - Editar produtos",
                  "- US-011 - Excluir produtos",
                  "",
                  "#### Tarefas",
                  "- Tela de cadastro",
                  "- Persistencia",
                  "- Upload de imagens",
                  "- Preco e descricao",
                  "- Logotipo customizado por lanchonete"
                ])
              },

              {
                title: "EPICO 4 - Multi-Lanchonete",
                body: ml([
                  "### Feature 4.1 - Identidade Visual",
                  "- US-012 - Cada lanchonete define nome, logo e cores",
                  "",
                  "### Feature 4.2 - SMTP configuravel",
                  "- US-013 - Usuario cadastra credenciais SMTP",
                  "- US-014 - Teste de envio",
                  "- US-015 - Envio automatico no final do pedido",
                  "",
                  "#### Tarefas",
                  "- Criar tela de configuracoes",
                  "- Criptografar credenciais localmente",
                  "- Implementar envio via SMTP (SSL/TLS)"
                ])
              },

              {
                title: "EPICO 5 - Relatorios",
                body: ml([
                  "### Feature 5.1 - Relatorio Diario",
                  "",
                  "#### Historias",
                  "- US-016 - Ver total do dia",
                  "- US-017 - Ver itens mais vendidos",
                  "",
                  "#### Tarefas",
                  "- Tela e filtros",
                  "- Exportar PDF",
                  "- Exportar CSV"
                ])
              },

              {
                title: "EPICO 6 - Administracao",
                body: ml([
                  "### Historias",
                  "- US-018 - Gerenciar usuarios (admin, atendente, cozinha)",
                  "- US-019 - Restringir acessos"
                ])
              }
            ];

            const createdIssues = [];

            for (const epic of epics) {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: epic.title,
                body: epic.body,
                labels: ["epic"]
              });

              createdIssues.push(issue.data.id);
            }

            core.setOutput("issues", JSON.stringify(createdIssues));

      - name: Add Epics to Epics Column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const columnId = '${{ steps.create-column.outputs.column_id }}';
            const issues = JSON.parse('${{ steps.create-issues.outputs.issues }}');

            for (const issueId of issues) {
              await github.rest.projects.createCard({
                column_id: columnId,
                content_type: "Issue",
                content_id: issueId
              });
            }

            console.log("Epicos adicionados na coluna Epics!");
